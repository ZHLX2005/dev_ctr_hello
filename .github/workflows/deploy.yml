name: Deploy

on:
  workflow_run:
    workflows: ["CI/CD"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      version:
        description: 'Version to deploy (format: v1.0.0)'
        required: true

jobs:
  check-tag:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_tag: ${{ steps.get_version.outputs.is_tag }}
      should_deploy: ${{ steps.get_version.outputs.should_deploy }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version info
      id: get_version
      run: |
        # 检查是否是tag推送
        if [[ "${{ github.event.workflow_run.head_branch }}" == "" ]]; then
          # 这是一个tag推送
          SHA="${{ github.event.workflow_run.head_sha }}"

          # 获取该commit对应的tag
          TAG=$(git tag --points-at $SHA | head -n 1)

          if [[ -n "$TAG" && "$TAG" == v* ]]; then
            echo "version=$TAG" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Found tag: $TAG"
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "No valid tag found"
          fi
        else
          # 不是tag推送
          echo "is_tag=false" >> $GITHUB_OUTPUT
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          echo "Not a tag push"
        fi

  deploy:
    runs-on: ubuntu-latest
    needs: check-tag
    if: |
      (needs.check-tag.outputs.should_deploy == 'true' && github.event_name == 'workflow_run') ||
      github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # 手动触发时使用输入的版本
          VERSION="${{ github.event.inputs.version }}"
        else
          # 自动触发时从check-tag获取版本
          VERSION="${{ needs.check-tag.outputs.version }}"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Deploying version: $VERSION"

    - name: Deploy to server via SSH
      if: steps.get_version.outputs.skip != 'true'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || 22 }}
        timeout: 30s
        command_timeout: 10m
        script: |
          # 使用bash执行脚本
          bash -c '
          # 设置变量
          VERSION="${{ steps.get_version.outputs.version }}"
          IMAGE_NAME="i718blu36dcakm-ghcr.xuanyuan.run/zhlx2005/dev_ctr_hello"
          CONTAINER_NAME="dev_ctr_hello_app"

          # 获取指定版本的镜像
          echo "Pulling image version: $VERSION"
          docker pull $IMAGE_NAME:$VERSION

          # 停止并删除旧容器
          echo "Stopping old container..."
          if docker ps -q -f name=$CONTAINER_NAME | grep -q .; then
            docker stop $CONTAINER_NAME
            docker rm $CONTAINER_NAME
          fi

          # 启动新容器
          echo "Starting new container with version: $VERSION"
          docker run -d \
            --name $CONTAINER_NAME \
            -p 8988:8080 \
            --restart unless-stopped \
            -e VERSION=$VERSION \
            $IMAGE_NAME:$VERSION

          # 显示运行状态
          echo "Container status:"
          docker ps | grep $CONTAINER_NAME

          # 健康检查
          echo "Performing health check..."
          sleep 5
          if curl -f http://localhost:8988/health; then
            echo "✅ Deployment successful! Version: $VERSION"
          else
            echo "❌ Health check failed!"
            exit 1
          fi
          '

  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment: production

    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || 22 }}
        script: |
          # 使用bash执行脚本
          bash -c '
          CONTAINER_NAME="dev_ctr_hello_app"

          echo "Rolling back deployment..."

          # 尝试重启容器
          if docker ps -a -q -f name=$CONTAINER_NAME | grep -q .; then
            docker restart $CONTAINER_NAME
            echo "Container restarted"
          else
            echo "No container found to rollback"
            exit 1
          fi

          # 检查状态
          sleep 5
          if curl -f http://localhost:8988/health; then
            echo "✅ Rollback successful!"
          else
            echo "❌ Rollback failed!"
            exit 1
          fi
          '