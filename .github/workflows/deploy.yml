name: Deploy File Server

on:
  push:
    branches: [ deploy ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: file-server:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Save Docker image
      run: |
        docker save file-server:latest | gzip > app.tar.gz

    - name: Copy image to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || 22 }}
        source: "app.tar.gz"
        target: "~/"

    - name: Load and run image on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || 22 }}
        timeout: 30s
        command_timeout: 10m
        script: |
          bash -c '
          # Set variables
          IMAGE_NAME="file-server"
          CONTAINER_NAME="file-server"
          STORAGE_DIR="/opt/file-server-storage"
          AUTH_TOKEN="${{ secrets.AUTH_TOKEN }}"
          DEFAULT_TTL="1h"

          # Create storage directory
          mkdir -p $STORAGE_DIR

          # Step 1: Stop and remove old container
          echo "Step 1: Stopping old container..."
          if docker ps -q -f name=$CONTAINER_NAME 2>/dev/null | grep -q .; then
            docker stop $CONTAINER_NAME
            docker rm $CONTAINER_NAME
            echo "Old container removed"
          else
            echo "No old container found"
          fi

          # Step 2: Remove old image (only file-server:latest)
          echo "Step 2: Removing old image..."
          if docker images -q $IMAGE_NAME:latest 2>/dev/null | grep -q .; then
            docker rmi $IMAGE_NAME:latest -f
            echo "Old image removed"
          else
            echo "No old image found"
          fi

          # Step 3: Load new image
          echo "Step 3: Loading new image..."
          docker load < app.tar.gz
          echo "New image loaded"

          # Clean up compressed file
          rm app.tar.gz

          # Step 4: Start new container
          echo "Step 4: Starting new container..."
          docker run -d \
            --name $CONTAINER_NAME \
            -p 8988:8080 \
            --restart unless-stopped \
            -v $STORAGE_DIR:/app/storage \
            -e AUTH_TOKEN=$AUTH_TOKEN \
            -e DEFAULT_TTL=$DEFAULT_TTL \
            -e STORAGE_DIR=/app/storage \
            $IMAGE_NAME:latest

          # Show container status
          echo "Container status:"
          docker ps -f name=$CONTAINER_NAME

          # Health check
          echo "Step 5: Health check..."
          sleep 5
          if curl -f http://localhost:8988/health; then
            echo "Deployment successful!"
          else
            echo "Health check failed!"
            docker logs $CONTAINER_NAME --tail 50
            exit 1
          fi
          '
